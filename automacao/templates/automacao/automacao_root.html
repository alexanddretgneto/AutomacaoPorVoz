<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Automa√ß√£o por Voz</title>
</head>
<body>
  <h1>Automa√ß√£o por Voz</h1>
  <p>Grave um comando de voz no formato:</p>
  <pre>aluno: alex neto, ano: 2¬∞, notas: 5.0, 6.0, 7.0, frequencia: 80</pre>

  <button id="startBtn">üé§ Gravar</button>
  <button id="stopBtn">üõë Parar</button>
  <button id="saveBtn">üíæ Salvar</button>

  <p><strong>Texto capturado:</strong></p>
  <textarea id="output" rows="5" cols="50"></textarea>

  <script>
    let recognition;
    let finalTranscript = "";

    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition();
      recognition.lang = "pt-BR";
      recognition.continuous = true;
      recognition.interimResults = true;

      recognition.onresult = (event) => {
        let interim = "";
        for (let i = event.resultIndex; i < event.results.length; i++) {
          let transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript + " ";
          } else {
            interim += transcript;
          }
        }
        document.getElementById("output").value = finalTranscript + interim;
      };
    } else {
      alert("Seu navegador n√£o suporta reconhecimento de voz.");
    }

    document.getElementById("startBtn").onclick = () => recognition.start();
    document.getElementById("stopBtn").onclick = () => recognition.stop();

    document.getElementById("saveBtn").onclick = async () => {
  const comando = document.getElementById("output").value.trim();
  if (!comando) {
    alert("‚ùå Nenhum comando para enviar!");
    return;
  }

  // Pega CSRF token do cookie (Django coloca automaticamente)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const csrftoken = getCookie("csrftoken");

  try {
    const resp = await fetch("/api/automacao/adicionar/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken  // envia token CSRF
      },
      body: JSON.stringify({ comando }),
      credentials: "include"      // envia cookies da sess√£o
    });

    const data = await resp.json();
    if (resp.status === 201) {
      alert("‚úÖ Registro salvo com sucesso: " + JSON.stringify(data));
    } else {
      alert("‚ö†Ô∏è Erro ao salvar: " + JSON.stringify(data));
    }
  } catch (error) {
    alert("‚ùå Erro ao conectar com a API: " + error);
  }
};
  </script>
</body>
</html>
